---
title: "Rat_fave_cuisine_analysis"
author: "HsuanYi Lee (hl3858)"
date: "2025-11-17"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE, 
  warning = FALSE, 
  message = FALSE
)
library(dplyr)
library(ggplot2)
library(patchwork)
library(readr)
library(tidyr)
```

```{r}
restaurant <- readRDS("~/p8105_final_project/data/restaurant_clean.rds")
rat_data <- readRDS("~/p8105_final_project/data/rat_data_cleaned.rds")

restaurant <- restaurant %>% mutate(ZIPCODE_fill = as.character(ZIPCODE_fill))
rat_data <- rat_data %>% mutate(Zip = as.character(Zip))
```

## Create Cuisine Summary
```{r}
cuisine_summary <- restaurant %>%
  select(CUISINE_CATEGORY, ZIPCODE_fill) %>%
  filter(ZIPCODE_fill != "") %>%
  group_by(CUISINE_CATEGORY, ZIPCODE_fill) %>%
  summarise(restaurant_count = n(), .groups = 'drop') %>%
  left_join(
    rat_data %>%
      filter(Zip != "") %>%
      group_by(Zip) %>%
      summarise(rat_count = n()),
    by = c("ZIPCODE_fill" = "Zip")
  ) %>%
  mutate(rat_count = replace_na(rat_count, 0)) %>%
  group_by(CUISINE_CATEGORY) %>%
  summarise(
    total_restaurants = sum(restaurant_count),
    total_rats = sum(rat_count),
    .groups = "drop"
  )
```

## Skewness Function
```{r}
calculate_skewness <- function(x) {
n <- length(x)
mean_x <- mean(x)
sd_x <- sd(x)
(sum((x - mean_x)^3) / n) / (sd_x^3)
}
```

## Results: Restaurants
```{r}
restaurant_stats <- cuisine_summary %>%
summarise(
n = n(),
mean = mean(total_restaurants),
median = median(total_restaurants),
sd = sd(total_restaurants),
min = min(total_restaurants),
max = max(total_restaurants),
skewness = calculate_skewness(total_restaurants),
shapiro_p = shapiro.test(total_restaurants)$p.value
)
restaurant_stats
```

## Results: Rats
```{r}
rat_stats <- cuisine_summary %>%
summarise(
n = n(),
mean = mean(total_rats),
median = median(total_rats),
sd = sd(total_rats),
min = min(total_rats),
max = max(total_rats),
skewness = calculate_skewness(total_rats),
shapiro_p = shapiro.test(total_rats)$p.value
)
rat_stats
```

## Histograms
```{r}
p1 <- ggplot(cuisine_summary, aes(x = total_restaurants)) +
geom_histogram(aes(y = ..density..), bins = 15, fill = "steelblue", alpha = 0.7) +
geom_density(color = "darkblue", linewidth = 1) +
labs(title="Distribution of Total Restaurants\nper Cuisine")

p2 <- ggplot(cuisine_summary, aes(x = total_rats)) +
geom_histogram(aes(y = ..density..), bins = 15, fill = "coral", alpha = 0.7) +
geom_density(color = "darkred", linewidth = 1) +
labs(title="Distribution of Total Rat Sightings\nper Cuisine")

p1 + p2
```

## Rat Sightings Ranking by Cuisine (Adjusted for restaurants)
```{r}
cuisine_rat_analysis <- restaurant %>%
select(CUISINE_CATEGORY, ZIPCODE_fill) %>%
group_by(CUISINE_CATEGORY, ZIPCODE_fill) %>%
summarise(Restaurant_Count = n(), .groups="drop") %>%
left_join(
rat_data %>% group_by(Zip) %>% summarise(Rat_Count = n()),
by = c("ZIPCODE_fill" = "Zip")
) %>%
mutate(Rat_Count = replace_na(Rat_Count, 0))

log_standardized_ranking <- cuisine_rat_analysis %>%
group_by(CUISINE_CATEGORY) %>%
summarise(
Total_Rats = sum(Rat_Count),
Total_Restaurants = sum(Restaurant_Count),
Unique_ZIPs = n_distinct(ZIPCODE_fill),
Rats_per_Restaurant = Total_Rats / Total_Restaurants
) %>%
filter(Total_Restaurants >= 50) %>%
mutate(
Log_Restaurants = log(Total_Restaurants + 1),
Standardized_Rats = scale(Total_Rats)[,1],
Standardized_Log_Restaurants = scale(Log_Restaurants)[,1],
Log_Standardized_Ratio = Standardized_Rats / Standardized_Log_Restaurants,
Normalized_Ratio = (Log_Standardized_Ratio - min(Log_Standardized_Ratio)) /
(max(Log_Standardized_Ratio) - min(Log_Standardized_Ratio))
) %>%
arrange(desc(Normalized_Ratio))

log_standardized_ranking %>%
select(CUISINE_CATEGORY, Total_Rats, Total_Restaurants, Normalized_Ratio) %>%
print(n = Inf)
```

## Rat Sightings Ranking (2.0 ZIP Weighted)
```{r}
zip_weighted_ranking <- cuisine_rat_analysis %>%
group_by(CUISINE_CATEGORY) %>%
summarise(
Total_Rats = sum(Rat_Count),
Total_Restaurants = sum(Restaurant_Count),
Unique_ZIPs = n_distinct(ZIPCODE_fill)
) %>%
filter(Total_Restaurants >= 50) %>%
mutate(
Weighted_Rats = Total_Rats * Unique_ZIPs,
Log_Restaurants = log(Total_Restaurants + 1),
Std_Weighted = scale(Weighted_Rats)[,1],
Std_Log = scale(Log_Restaurants)[,1],
Log_Standardized_Ratio = Std_Weighted / Std_Log,
Normalized_Ratio = (Log_Standardized_Ratio - min(Log_Standardized_Ratio)) /
(max(Log_Standardized_Ratio) - min(Log_Standardized_Ratio))
) %>%
arrange(desc(Normalized_Ratio))

zip_weighted_ranking %>%
select(CUISINE_CATEGORY, Total_Rats, Total_Restaurants, Unique_ZIPs, Normalized_Ratio) %>%
print(n = Inf)
```